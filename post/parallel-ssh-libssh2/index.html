<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>parallel-ssh Clients</title>
  <meta property="og:title" content="parallel-ssh Clients" />
  <meta name="twitter:title" content="parallel-ssh Clients" />
  <meta name="description" content="paramiko vs libssh2">
  <meta property="og:description" content="paramiko vs libssh2">
  <meta name="twitter:description" content="paramiko vs libssh2">
  <meta name="author" content="Panos Kittenis"/>
  <link href='https://parallel-ssh.org/static/favicon.png' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://parallel-ssh.org/static/avatar-icon.png" />
  <meta name="twitter:image" content="https://parallel-ssh.org/static/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://parallel-ssh.org/post/parallel-ssh-libssh2/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="ParallelSSH" />

  <meta name="generator" content="Hugo 0.40.3" />
  <link rel="canonical" href="https://parallel-ssh.org/post/parallel-ssh-libssh2/" />
  <link rel="alternate" href="https://parallel-ssh.org/index.xml" type="application/rss+xml" title="ParallelSSH">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://parallel-ssh.org/css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://parallel-ssh.org/css/pygment_highlights.css" />
  <link rel="stylesheet" href="https://parallel-ssh.org/css/highlight.min.css" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-9132694-6', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://parallel-ssh.org/">ParallelSSH</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Projects</a>
              <div class="navlinks-children">
                
                  <a href="https://github.com/ParallelSSH/parallel-ssh">parallel-ssh</a>
                
                  <a href="https://github.com/ParallelSSH/ssh2-python">ssh2-python</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="About" href="/about/">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="ParallelSSH" href="https://parallel-ssh.org/">
            <img class="avatar-img" src="https://parallel-ssh.org/static/avatar-icon.png" alt="ParallelSSH" />
          </a>
        
      </div>
    </div>

  </div>
</nav>




    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>parallel-ssh Clients</h1>
                
                  
                    <h2 class="post-subheading">paramiko vs libssh2</h2>
                  
                
                
                  <span class="post-meta">
  Posted on October 14, 2017
  
</span>


                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        

<p>In a <a href="../ssh2-python">previous post</a> a comparison was shown between two SSH library options for Python, with emphasis on their performance using native threads for scaling purposes.</p>

<p>For this post, their non-blocking performance using the gevent library will be compared as the two SSH library options available now in <a href="https://github.com/ParallelSSH/parallel-ssh">parallel-ssh</a>.</p>

<p><em>Post has been updated with further scaling graphs for both clients.</em></p>

<h1 id="test-setup">Test Setup</h1>

<p>Test script (see appendix) consists of identical <code>parallel-ssh</code> code for the two available parallel clients in the library, using <code>paramiko</code> and <code>libssh2</code> via <code>ssh2-python</code> respectively as the underlying SSH libraries. The latest version of the library as of this time of writing was used - <code>1.2.0</code> - with latest underlying libraries as installed by its requirements and latest version of <code>gevent</code> - <code>1.2.2</code>.</p>

<p>The script creates SSH sessions in parallel to a local to the client SSH server via loop back device, with concurrencystarting from one and increasing by one until completion.</p>

<p>A maximum concurrency of two hundred sessions is used for the comparison tests.</p>

<p>A single remote command, <code>cat</code> of a <a href="https://github.com/ParallelSSH/ssh2-python/blob/master/LICENSE">26KB static file</a>, is performed and standard output read one line at a time as parsed by the respective libraries.</p>

<p>Timings are shown for:</p>

<ul>
<li>Auth and execute - connection, authentication and execute command sent for all hosts</li>
<li>Close and exit status - wait for execute completion, close execute channel and get exit status (SSH session remains open)</li>
<li>Execute - same remote command executed again on the same SSH session</li>
<li>Channel read - read complete remote output line by line</li>
</ul>

<p>All durations are in milliseconds (ms) or multiples of. All tests performed on Linux, kernel version <code>4.4</code> on a six core CPU and OpenSSH <code>7.5r1</code> with OpenSSL <code>1.0.2l</code>.</p>

<p>Click on images for larger versions.</p>

<h2 id="test-results">Test Results</h2>

<p>Graphs show median values per five second intervals.</p>

<p>Here is how the two SSH clients compare on the above timings plus total time spent.</p>

<h3 id="clients-comparison">Clients Comparison</h3>

<p>Shown below is time taken for <em>all</em> hosts in total.</p>

<h3 id="two-hundred-concurrent-sessions">Two hundred concurrent sessions</h3>

<p>Separate graphs for the two clients for up to two hundred concurrent sessions.</p>

<p><a href="/static/pssh_clients_scaling.png"><img src="/static/pssh_clients_scaling.png" alt="parallel-ssh ssh2 paramiko" title="Further Scaling" /></a></p>

<h3 id="one-hundred-concurrent-sessions-combined-graph">One hundred concurrent sessions combined graph</h3>

<p><a href="/static/pssh_clients.png"><img src="/static/pssh_clients.png" alt="parallel-ssh ssh2 paramiko" title="Clients Comparison" /></a></p>

<h2 id="individual-results">Individual Results</h2>

<p>Results for the clients individually up to one hundred concurrent sessions, including CPU and memory usage graphs.</p>

<p><a href="/static/pssh_ssh2.png"><img src="/static/pssh_ssh2.png" alt="parallel-ssh ssh2" title="Individual SSH2" /></a></p>

<p><a href="/static/pssh_paramiko.png"><img src="/static/pssh_paramiko.png" alt="parallel-ssh paramiko" title="Individual paramiko" /></a></p>

<p>The <code>ssh2-python</code> based client is shown to use about 250MB less memory and fully utilising a little more than three cores at one hundred concurrency, with the <code>paramiko</code> client a little more than one core.</p>

<h2 id="notes">Notes</h2>

<p>Further scaling of the <code>ssh2</code> client is possible, though <code>gevent</code> and event loop overhead leads to diminishing returns, seen in the highest concurrency graph as intermittent spikes in latency that increase in frequency as concurrency ramps up. No limit was found as to how far concurrency could be increased.</p>

<p>On already authenticated sessions, executing new commands remains fairly low latency on the <code>ssh2</code> client even at high concurrency levels.</p>

<p>The paramiko client shows worse than linear scaling against number of concurrent sessions, continually increasing up to the two hundred concurrent sessions tested. It would also often experience dead locks at all concurrency levels.</p>

<p>Performance gap between the two clients continues increasing as concurrency ramps up with similar scaling for the respective clients as seen in previous graphs.</p>

<h1 id="relative-performance">Relative Performance</h1>

<p>Relative performance of average times of the two libraries for the duration of the test at one hundred concurrent sessions.</p>

<p>For example if a <code>paramiko</code> operation were twice as fast as the equivalent <code>ssh2-python</code> operation, its relative performance would be <code>x0.5</code> of <code>ssh2-python</code> whereas identical durations would result in <code>x1</code> relative performance.</p>

<table>
<thead>
<tr>
<th>Operation</th>
<th>paramiko average</th>
<th>ssh2 average</th>
<th>paramiko/ssh2 relative average</th>
<th>100 concurrency</th>
<th>200 concurrency</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>auth and execute</code></td>
<td>7.1 sec</td>
<td>1.71 sec</td>
<td><code>4.15x</code></td>
<td><code>2.98x</code></td>
<td><code>7.08x</code></td>
</tr>

<tr>
<td><code>close and exit status</code></td>
<td>10 ms</td>
<td>1 ms</td>
<td><code>10x</code></td>
<td><code>2.25x</code></td>
<td><code>3.57x</code></td>
</tr>

<tr>
<td><code>execute</code></td>
<td>466 ms</td>
<td>174 ms</td>
<td><code>2.67x</code></td>
<td><code>3.38x</code></td>
<td><code>3.44x</code></td>
</tr>

<tr>
<td><code>channel read</code></td>
<td>379 ms</td>
<td>173 ms</td>
<td><code>2.19x</code></td>
<td><code>2.07x</code></td>
<td><code>2.35x</code></td>
</tr>

<tr>
<td><strong><code>total</code></strong></td>
<td><strong>7.95 sec</strong></td>
<td><strong>1.71 sec</strong></td>
<td><strong><code>4.64x</code></strong></td>
<td><strong><code>2.86x</code></strong></td>
<td><strong><code>6.16x</code></strong></td>
</tr>
</tbody>
</table>

<h1 id="postface">Postface</h1>

<p>At one hundred concurrent sessions, the <code>ssh2</code> client is shown to be <code>2.86</code> times faster.</p>

<p>At two hundred concurrent sessions, the <code>ssh2</code> client is shown to be <code>6.16</code> times faster.</p>

<p>On average for the duration of the test ranging from one to two hundred (1-200) concurrent sessions, the <code>ssh2-python</code> (<code>libssh2</code>) based client in <code>parallel-ssh</code> is shown to be a little more than four and a half times faster than the paramiko based client.</p>

<p>Latency for <code>gevent</code> based non-blocking clients compared to <a href="../ssh2-python">previous threading tests</a> is, as expected, much lower for both clients while also allowing for much higher scaling.</p>

<p>The <code>ssh2</code> client in particular has lower latency at <strong>two hundred</strong> concurrent sessions in the non-blocking test - <code>2.72 sec</code> - as the threading test has at <strong>fifty</strong> concurrent sessions - <code>3.62 sec</code>. The paramiko client also shows lower latency in the non-blocking test, though still taking over <code>16 sec</code> in total at two hundred concurrency.</p>

<p>Note that SFTP operations which <a href="../ssh2-python">were previously shown to benefit the most</a> are not shown here as tests are against a single, local, SSH server and <code>parallel-ssh</code> SFTP operations are for copying files which would overwrite each other if copied to/from the same server.</p>

<p>It is also worth pointing out that this test puts a lot of strain on gevent and the event loop as the commands are short lived, causing contention on the event loop from all the coroutines wanting to execute. This can be seen in the graphs by the intermittent spikes in latency for both clients which increase in frequency as concurrency ramps up.</p>

<p>For longer lived remote commands, scaling can continue before diminishing returns stemming from event loop and gevent overhead.</p>

<p>In all, tests show good scaling for the native library based client and the benefits of using native code extensions in Python libraries.</p>

<p>Combining native code extensions for network libraries with a non-blocking mode and non-blocking network libraries like <code>gevent</code> allows for very good performance while at the same time benefiting from the ease of use and conciseness of the Python language.</p>

<p>In future it would be interesting to examine further scaling of gevent and the event loop via native threads which is only possible with native code extensions that release Python&rsquo;s GIL, putting <code>parallel-ssh</code> in a good position to take advantage of.</p>

<h1 id="appendix">Appendix</h1>

<p>Test script and dashboard used can be found below:</p>

<ul>
<li><a href="https://gist.githubusercontent.com/pkittenis/e0221acae77fd0fc251951dd9c6aa69b">Performance test script</a></li>
<li><a href="https://gist.github.com/pkittenis/c47938539d2e8880ca920f2f1cc02abe">Grafana Dashboard for graphs</a></li>
</ul>

<p><a href="https://github.com/InfluxGraph/influxgraph/blob/master/docker/compose/">Docker compose file</a> can be used as-is to easily setup the dashboard, API and DB services as described below.</p>

<p>The test script writes data to a local <a href="https://portal.influxdata.com/downloads">InfluxDB</a> via its Graphite service using a <code>measurement.field*</code> <a href="https://github.com/influxdata/influxdb/tree/master/services/graphite#templates">template</a>.</p>

<p>Graphs were generated by <a href="https://grafana.com">Grafana</a>, as queried from InfluxDB by <a href="https://github.com/InfluxGraph/influxgraph">InfluxGraph</a> using the <a href="https://github.com/InfluxGraph/influxgraph#influxdb-graphite-metric-templates">same template configuration as InfluxDB</a>.</p>

<p>To replicate results, take care to use the exact versions of the libraries used here, including <code>libssh2</code>.</p>

      </article>

      <ul class="pager blog-pager">
        
          <li class="previous">
            <a href="https://parallel-ssh.org/post/ssh2-python/" data-toggle="tooltip" data-placement="top" title="The State of Python SSH Libraries">&larr; Previous Post</a>
          </li>
        
        
          <li class="next">
            <a href="https://parallel-ssh.org/post/parallel-ssh-1.6.0/" data-toggle="tooltip" data-placement="top" title="parallel-ssh 1.6.0 release">Next Post &rarr;</a>
          </li>
        
      </ul>

      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:zuboci@yandex.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/ParallelSSH" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="https://parallel-ssh.org/index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="parallel-ssh.org">Panos Kittenis</a>
                      
          
          
          &nbsp;&bull;&nbsp;
          2018

          
            &nbsp;&bull;&nbsp;
            <a href="https://parallel-ssh.org/">ParallelSSH</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.40.3</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://parallel-ssh.org/js/main.js"></script>
<script src="https://parallel-ssh.org/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>
<script src="https://parallel-ssh.org/js/load-photoswipe.js"></script>



  </body>
</html>

